events {}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    server {
        listen 80;
        server_name {{ domain }};
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name {{ domain }};

        ssl_certificate     /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # SSE endpoint — must disable buffering and use a long read timeout
        location /api/routes/stream {
            proxy_pass http://app:8000;
            proxy_buffering        off;
            proxy_cache            off;
            proxy_read_timeout     300s;
            proxy_set_header       Connection '';
            proxy_set_header       Host $host;
            proxy_set_header       X-Real-IP $remote_addr;
            chunked_transfer_encoding off;
        }

        # All other API calls
        location /api/ {
            proxy_pass http://app:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /healthz {
            proxy_pass http://app:8000;
        }

        # React SPA — serve static files, fall back to index.html
        location / {
            root  /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
            expires 1h;
            add_header Cache-Control "public, max-age=3600";
        }

        # Vite asset hashes are content-addressed — cache aggressively
        location /assets/ {
            root  /usr/share/nginx/html;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
