services:
  app:
    image: "{{ app_image }}"   # built and pushed by CI or ansible
    environment:
      DJANGO_SETTINGS_MODULE: config.settings
      SECRET_KEY: "{{ app_secret_key }}"
      DEBUG: "False"
      ALLOWED_HOSTS: "{{ domain }}"
      VALHALLA_URL: "{{ valhalla_url }}"
      NOMINATIM_URL: "{{ nominatim_url }}"
    ports:
      - "127.0.0.1:8000:8000"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/frontend/dist:/usr/share/nginx/html:ro
      - certs:/etc/letsencrypt
    ports:
      - "443:443"
      - "80:80"
    depends_on:
      - app
    restart: unless-stopped

volumes:
  certs:
